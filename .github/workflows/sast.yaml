name: CI SAST Scan

on:
  push:
    branches: [ snyk ]

env:
  PROJECT_ID: ${{ secrets.GKE_PROJECT }}
  GKE_CLUSTER: fianu-prod  # TODO: update to cluster name
  GKE_ZONE: us-central1-c   # TODO: update to cluster zone
  DEPLOYMENT_NAME: gke-test # TODO: update to deployment name
  FIANU_ARTIFACT: xd-banking-api
  FIANU_VERSION: ${{ secrets.FIANU_VERSION }}
  FIANU_HOST: ${{ secrets.FIANU_HOST }}
  FIANU_KEY: ${{ secrets.FIANU_COSIGN_KEY }}
  REKOR_HOST: ${{ secrets.REKOR_URL }}
  GITHUB_CONTEXT: ${{ toJSON(github) }}

defaults:
  run:
    working-directory: ./xd-banking-api

jobs:

  init:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: setup fianu
        uses: fianulabs/actions@main
        with:
          version: ${{ env.FIANU_VERSION }}

      - name: Auto Set Build Version
        run: |-
          export FIANU_ARTIFACT_VERSION="$(fianu get version)"
          echo "FIANU_ARTIFACT_VERSION=$FIANU_ARTIFACT_VERSION" >> $GITHUB_ENV
          ls

  inner:
    name: Security Tooling
    uses: fianulabs/tools/.github/workflows/build.yaml@main
    secrets: inherit
    with:
      working-directory: ./xd-banking-api
      project-type: golang